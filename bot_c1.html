<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body, html {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5; /* –¶–≤–µ—Ç —Ñ–æ–Ω–∞ –∫–∞–∫ –≤ Telegram */
            margin: 0;
            padding: 0;
            min-height: 100vh;
            color: #000;
        }
        .app-container {
            background: #fff;
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            min-height: calc(100vh - 40px);
        }
        .btn {
            width: 100%;
            padding: 14px;
            margin-bottom: 12px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .btn-secondary {
            background-color: #eef1f4;
            color: #2a61b5;
        }
        .btn-primary {
            text-align: center;
            justify-content: center;
            background-color: #2a81e8;
            color: #fff;
        }
        .btn-danger {
            text-align: center;
            justify-content: center;
            background-color: #eb5757;
            color: #fff;
        }
        .result-block {
            width: 100%;
            height: 280px;
            background: #f3f4f6;
            border-radius: 10px;
            margin-top: 16px;
            padding: 12px;
            box-sizing: border-box;
            overflow-y: auto;
            font-family: 'Menlo', 'Consolas', monospace;
            font-size: 12px;
            color: #111827;
            display: flex;
            flex-direction: column-reverse; /* –í—ã–≤–æ–¥ –ª–æ–≥–æ–≤ —Å–Ω–∏–∑—É –≤–≤–µ—Ä—Ö */
        }
        .overlay-panel {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(240, 242, 245, 0.95);
            z-index: 10;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            opacity: 0; visibility: hidden;
            transition: opacity 0.2s;
        }
        .overlay-panel.active { opacity: 1; visibility: visible; }
        .input-field {
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            border: 2px solid #aab6c4;
            margin-bottom: 10px;
            font-size: 16px;
            box-sizing: border-box;
        }
        #balance-display {
            text-align: center;
            font-size: 14px;
            padding: 10px;
            background-color: #eef1f4;
            color: #333;
            border-radius: 12px;
            font-weight: 500;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
<div id="app-container" class="app-container">
    <button class="btn btn-secondary" onclick="showOverlay('pair')">–ü–∞—Ä–∞: <span id="display_pair"></span></button>
    <button class="btn btn-secondary" onclick="showOverlay('action')">–î–µ–π—Å—Ç–≤–∏–µ: <span id="display_action"></span></button>
    <button class="btn btn-secondary" onclick="showInputOverlay('profit')">–ü—Ä–∏–±—ã–ª—å %: <span id="display_profit"></span></button>
    <button class="btn btn-secondary" onclick="showInputOverlay('loss')">–£–±—ã—Ç–æ–∫ %: <span id="display_loss"></span></button>
    <button class="btn btn-secondary" onclick="showOverlay('total')">–í—Å–µ–≥–æ %: <span id="display_total"></span></button>
    
    <div id="balance-display">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>

    <button class="btn btn-primary" id="start-btn" onclick="startTrade()">üöÄ –°–¢–ê–†–¢</button>

    <div class="result-block" id="result-block"></div>
    <button class="btn btn-danger" onclick="exitAndClose()">–í–´–•–û–î</button>

    <div id="overlay-pair" class="overlay-panel">
        <div style="width:90%;max-width:350px;">
            <button class="btn btn-secondary" onclick="selectPair('BTCFDUSD')">BTCFDUSD</button>
            <button class="btn btn-secondary" onclick="selectPair('ETHFDUSD')">ETHFDUSD</button>
            <button class="btn btn-primary" onclick="hideAllOverlays()">–ù–∞–∑–∞–¥</button>
        </div>
    </div>
    <div id="overlay-action" class="overlay-panel">
         <div style="width:90%;max-width:350px;">
            <button class="btn btn-secondary" onclick="selectAction('buy')">–ö—É–ø–∏—Ç—å</button>
            <button class="btn btn-secondary" onclick="selectAction('sell')">–ü—Ä–æ–¥–∞—Ç—å</button>
            <button class="btn btn-primary" onclick="hideAllOverlays()">–ù–∞–∑–∞–¥</button>
        </div>
    </div>
    <div id="overlay-total" class="overlay-panel">
         <div style="width:90%;max-width:350px;">
            <button class="btn btn-secondary" onclick="selectTotal(30)">30</button>
            <button class="btn btn-secondary" onclick="selectTotal(50)">50</button>
            <button class="btn btn-secondary" onclick="selectTotal(100)">100</button>
            <button class="btn btn-primary" onclick="hideAllOverlays()">–ù–∞–∑–∞–¥</button>
        </div>
    </div>
    <div id="overlay-input" class="overlay-panel">
        <div style="width:90%;max-width:350px;">
            <h3 id="input-label" style="text-align:center; margin-bottom:18px;"></h3>
            <input id="input-value" class="input-field" type="number" step="any">
            <button class="btn btn-primary" onclick="confirmInput()">OK</button>
            <button class="btn btn-secondary" onclick="hideAllOverlays()">–ù–∞–∑–∞–¥</button>
        </div>
    </div>
</div>
<script>
    // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
    const API_HOST = "https://0570da370db6.ngrok-free.app"; // <-- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∞–¥—Ä–µ—Å –≤–µ—Ä–Ω—ã–π!
    
    let params = {
        pair: "ETHFDUSD", action: "buy",
        profit: 0.2, loss: 0.1, total: 50
    };
    let ws = null, reconnectTimeout = null;

    // --- –§–£–ù–ö–¶–ò–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê ---
    function updateDisplay() {
        for (const key in params) {
            document.getElementById(`display_${key}`).textContent = params[key];
        }
    }
    function showOverlay(type) { document.getElementById(`overlay-${type}`).classList.add('active'); }
    function hideAllOverlays() { document.querySelectorAll('.overlay-panel').forEach(el => el.classList.remove('active')); }
    
    function showInputOverlay(field) {
        const labels = { profit: "–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏–±—ã–ª—å (%)", loss: "–í–≤–µ–¥–∏—Ç–µ —É–±—ã—Ç–æ–∫ (%)" };
        document.getElementById('input-label').textContent = labels[field];
        const input = document.getElementById('input-value');
        input.value = params[field];
        input.dataset.field = field;
        showOverlay('input');
    }

    function confirmInput() {
        const input = document.getElementById('input-value');
        const field = input.dataset.field;
        if (!input.value || isNaN(input.value)) return;
        params[field] = Number(input.value);
        hideAllOverlays();
        updateDisplay();
    }

    function selectPair(pair) {
        params.pair = pair;
        hideAllOverlays();
        updateDisplay();
        fetchAndShowBalance();
    }
    function selectAction(action) { params.action = action; hideAllOverlays(); updateDisplay(); }
    function selectTotal(val) { params.total = val; hideAllOverlays(); updateDisplay(); }

    // --- –°–ï–¢–ï–í–´–ï –ó–ê–ü–†–û–°–´ ---
    async function fetchAndShowBalance() {
        const balanceDisplay = document.getElementById('balance-display');
        balanceDisplay.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–ª–∞–Ω—Å–∞...";

        if (!window.Telegram?.WebApp?.initData) {
            balanceDisplay.textContent = "–û—à–∏–±–∫–∞: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö Telegram –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.";
            return;
        }
        try {
            const resp = await fetch(`${API_HOST}/get_balance`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "ngrok-skip-browser-warning": "true" // 3. –í–ê–ñ–ù–´–ô –ó–ê–ì–û–õ–û–í–û–ö –î–õ–Ø NGROK
                },
                body: JSON.stringify({
                    initData: window.Telegram.WebApp.initData,
                    pair: params.pair
                })
            });

            if (!resp.ok) throw new Error(`HTTP ${resp.status}: ${await resp.text()}`);

            const data = await resp.json();
            if (data.error) throw new Error(data.error);

            balanceDisplay.innerHTML = `<b>${data.base}:</b> ${parseFloat(data.base_balance).toFixed(6)} | <b>${data.quote}:</b> ${parseFloat(data.quote_balance).toFixed(2)}`;
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –±–∞–ª–∞–Ω—Å–∞:", e); // –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
            balanceDisplay.textContent = "‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞";
        }
    }

    async function startTrade() {
        setResult("–û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã –Ω–∞ —Å—Ç–∞—Ä—Ç...");
        if (!window.Telegram?.WebApp?.initData) {
            setResult("–û—à–∏–±–∫–∞: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö Telegram –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.");
            return;
        }
        try {
            const resp = await fetch(`${API_HOST}/start_trade`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "ngrok-skip-browser-warning": "true"
                },
                body: JSON.stringify({
                    ...params,
                    initData: window.Telegram.WebApp.initData
                })
            });
            if (!resp.ok) throw new Error(`HTTP ${resp.status}: ${await resp.text()}`);
            const data = await resp.json();
            if (data.error) throw new Error(data.error);
        } catch(e) {
            console.error("–û—à–∏–±–∫–∞ —Å—Ç–∞—Ä—Ç–∞ —Ç–æ—Ä–≥–æ–≤–ª–∏:", e);
            setResult(`‚ö†Ô∏è –û—à–∏–±–∫–∞: ${e.message}`);
        }
    }

    function exitAndClose() {
        setResult("–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞ –∏ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–∏...");
        fetch(`${API_HOST}/stop_telegram`, { 
            method: "POST", 
            headers: { "ngrok-skip-browser-warning": "true" }
        })
        .catch(e => console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞:", e))
        .finally(() => {
            // 4. –ó–ê–ö–†–´–¢–ò–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
            window.Telegram?.WebApp?.close();
        });
    }

    // --- WEBSOCKET –ò –õ–û–ì–ò ---
    function setResult(text) {
        const block = document.getElementById("result-block");
        block.innerHTML = "";
        text.split("\n").forEach(line => {
            if (!line.trim()) return;
            const div = document.createElement("div");
            div.textContent = line;
            block.appendChild(div);
        });
    }

    function connectWS() {
        if (ws) ws.close();
        const ws_host = API_HOST.replace(/^http/, 'ws');
        ws = new WebSocket(`${ws_host}/ws`);
        
        ws.onopen = () => setResult("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ª–æ–≥–∞–º–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.");
        ws.onmessage = (event) => setResult(event.data);
        ws.onclose = () => {
            clearTimeout(reconnectTimeout);
            reconnectTimeout = setTimeout(connectWS, 3000);
        };
        ws.onerror = (err) => console.error('WebSocket Error:', err);
    }

    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
    document.addEventListener("DOMContentLoaded", () => {
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand(); // –†–∞—Å–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
            document.body.style.backgroundColor = tg.themeParams.bg_color || '#f0f2f5';
            document.body.style.color = tg.themeParams.text_color || '#000';
            document.getElementById('app-container').style.backgroundColor = tg.themeParams.secondary_bg_color || '#fff';
        }
        updateDisplay();
        fetchAndShowBalance();
        connectWS();
    });
</script>
</body>
</html>
