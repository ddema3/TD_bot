<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель управления</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #355C7D 0%, #2A5298 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        .app-container {
            background: rgba(255,255,255,0.96);
            border-radius: 16px;
            padding: 20px 16px 16px 16px;
            margin: 30px auto 0 auto;
            max-width: 480px;
            box-shadow: 0 6px 30px rgba(50,60,80,0.13);
        }
        .param-block {
            margin-bottom: 10px;
        }
        .custom-button, .rocket-button, .exit-button {
            width: 100%;
            min-height: 52px;
            border-radius: 16px;
            border: 2px solid #1e40af;
            background: #f8fafc;
            margin-bottom: 10px;
            font-size: 1.17rem;
            font-weight: bold;
            color: #1e40af;
        }
        .rocket-button {
            background: linear-gradient(90deg, #60a5fa 0%, #818cf8 100%);
            color: #fff;
            border: none;
        }
        .exit-button {
            margin-top: 20px;
            background: #f87171;
            color: #fff;
            border: none;
        }
        .input-field {
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            border: 2px solid #818cf8;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        .result-block {
            width: 100%;
            height: 320px;
            background: #f1f5f9;
            border-radius: 10px;
            margin: 14px 0 0 0;
            padding: 12px 8px 12px 8px;
            overflow-y: auto;
            font-family: 'Fira Mono', 'Consolas', monospace;
            font-size: 1em;
            color: #1e293b;
            display: flex;
            flex-direction: column-reverse;
        }
        .result-line {
            white-space: pre-wrap;
            padding: 0;
            margin-bottom: 2px;
        }
        .overlay-panel {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(255,255,255,0.98);
            z-index: 10;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            opacity: 0; visibility: hidden;
            transition: opacity 0.2s;
        }
        .overlay-panel.active { opacity: 1; visibility: visible; }
    </style>
</head>
<body>
<div class="app-container" id="app">
    <div id="main-panel-content">
        <div class="param-block">
            <button class="custom-button" onclick="showOverlay('pair')">Пара: <span id="display_pair">ETHFDUSD</span></button>
        </div>
        <div class="param-block">
            <button class="custom-button" onclick="showOverlay('action')">Действие: <span id="display_action">buy</span></button>
        </div>
        <div class="param-block">
            <button class="custom-button" onclick="showInputOverlay('profit')">Прибыль %: <span id="display_profit">0.2</span></button>
        </div>
        <div class="param-block">
            <button class="custom-button" onclick="showInputOverlay('loss')">Убыток %: <span id="display_loss">0.1</span></button>
        </div>
        <div class="param-block">
            <button class="custom-button" onclick="showOverlay('total')">Всего %: <span id="display_total">50</span></button>
        </div>
        <div class="param-block">
            <button class="rocket-button" id="start-btn" onclick="startTrade()" style="margin-bottom:0;">СТАРТ</button>
        </div>
        <div class="result-block" id="result-block"></div>
        <button class="exit-button" onclick="stopTrade()">ОСТАНОВИТЬ ТОРГОВЛЮ</button>
    </div>

    <div id="overlay-pair" class="overlay-panel">
        <div style="width:100%;max-width:350px;text-align:center;">
            <h3 style="margin-bottom:18px;">Выберите пару</h3>
            <button class="custom-button" onclick="selectPair('BTCFDUSD')">BTCFDUSD</button>
            <button class="custom-button" onclick="selectPair('ETHFDUSD')">ETHFDUSD</button>
            <button class="custom-button" onclick="hideAllOverlays()">Назад</button>
        </div>
    </div>
    <div id="overlay-action" class="overlay-panel">
        <div style="width:100%;max-width:350px;text-align:center;">
            <h3 style="margin-bottom:18px;">Действие</h3>
            <button class="custom-button" onclick="selectAction('buy')">Купить</button>
            <button class="custom-button" onclick="selectAction('sell')">Продать</button>
            <button class="custom-button" onclick="hideAllOverlays()">Назад</button>
        </div>
    </div>
    <div id="overlay-total" class="overlay-panel">
        <div style="width:100%;max-width:350px;text-align:center;">
            <h3 style="margin-bottom:18px;">Всего (%)</h3>
            <button class="custom-button" onclick="selectTotal(30)">30</button>
            <button class="custom-button" onclick="selectTotal(50)">50</button>
            <button class="custom-button" onclick="selectTotal(100)">100</button>
            <button class="custom-button" onclick="hideAllOverlays()">Назад</button>
        </div>
    </div>
    <div id="overlay-input" class="overlay-panel">
        <div style="width:100%;max-width:350px;text-align:center;">
            <h3 id="input-label" style="margin-bottom:18px;"></h3>
            <input id="input-value" class="input-field" type="number" step="any">
            <button class="custom-button" onclick="confirmInput()">OK</button>
            <button class="custom-button" onclick="hideAllOverlays()">Назад</button>
        </div>
    </div>
</div>

<script>
    // Если хотите, можно явно указать API_HOST, иначе будет использовать window.location.origin
    // Оставлено пустым для использования текущего домена/IP
    const API_HOST = ""; 

    // --- Логика получения initData (критично для аутентификации) ---
    function getInitDataFallbackFromHash() {
        try {
            if (!window.location.hash) return null;
            const h = window.location.hash.replace(/^#/, '');
            const params = new URLSearchParams(h.replace(/\?/g, '&'));
            const raw = params.get('tgWebAppData') || params.get('tgWebAppInitData') || params.get('tgWebAppDataUnsafe') || null;
            if (raw) {
                const decoded = decodeURIComponent(raw);
                return decoded;
            }
            if (h.startsWith('tgWebAppData=')) {
                const idx = h.indexOf('=');
                const val = h.slice(idx + 1);
                return decodeURIComponent(val);
            }
            return null;
        } catch (e) {
            console.error("Error parsing initData from hash:", e);
            return null;
        }
    }

    function resolveInitData() {
        try {
            if (window.Telegram && window.Telegram.WebApp) {
                const d = window.Telegram.WebApp.initData || window.Telegram.WebApp.initDataUnsafe?.data || null;
                if (d) return d;
            }
        } catch (e) { /* ignore */ }
        
        const fromHash = getInitDataFallbackFromHash();
        if (fromHash) {
            return fromHash;
        }
        return null;
    }
    // -----------------------------------------------------------------

    let params = {
        pair: "ETHFDUSD", action: "buy",
        profit: 0.2, loss: 0.1, total: 50
    };
    let ws = null, reconnectTimeout = null;

    function updateDisplay() {
        document.getElementById('display_pair').textContent = params.pair;
        document.getElementById('display_action').textContent = params.action;
        document.getElementById('display_profit').textContent = params.profit;
        document.getElementById('display_loss').textContent = params.loss;
        document.getElementById('display_total').textContent = params.total;
    }

    function showOverlay(type) {
        hideAllOverlays();
        document.getElementById('overlay-' + type).classList.add('active');
    }
    function hideAllOverlays() {
        document.querySelectorAll('.overlay-panel').forEach(el => el.classList.remove('active'));
    }
    function showInputOverlay(field) {
        hideAllOverlays();
        const labels = { profit: "Введите прибыль (%)", loss: "Введите убыток (%)" };
        document.getElementById('input-label').textContent = labels[field];
        const input = document.getElementById('input-value');
        input.value = params[field];
        input.dataset.field = field;
        document.getElementById('overlay-input').classList.add('active');
    }
    function confirmInput() {
        const field = document.getElementById('input-value').dataset.field;
        const val = document.getElementById('input-value').value;
        if (!val || isNaN(val) || Number(val) < 0) return; // Простая валидация на положительное число
        params[field] = Number(val);
        hideAllOverlays();
        updateDisplay();
    }
    function selectPair(pair) {
        params.pair = pair;
        hideAllOverlays();
        updateDisplay();
        fetchAndShowBalance();
    }
    function selectAction(action) {
        params.action = action;
        hideAllOverlays();
        updateDisplay();
    }
    function selectTotal(val) {
        params.total = val;
        hideAllOverlays();
        updateDisplay();
    }

    async function fetchAndShowBalance() {
        setResult("Загрузка баланса...");
        const initData = resolveInitData();
        if (!initData) {
            return setResult("Ошибка: Не удалось получить данные Telegram для аутентификации.");
        }
        try {
            const resp = await fetch(`${(API_HOST || window.location.origin)}/get_balance`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "ngrok-skip-browser-warning": "true"
                },
                body: JSON.stringify({
                    tg_init_data: initData, // Отправляем initData для проверки
                    pair: params.pair
                })
            });
            const data = await resp.json();
            if (data.status === 'error') setResult(`Ошибка: ${data.message}`);
            else setResult(`Баланс:\n${data.base}: ${data.base_balance}\n${data.quote}: ${data.quote_balance}`);
        } catch (e) {
            console.error("Ошибка соединения с сервером (баланс):", e);
            setResult("Ошибка соединения с сервером (баланс)");
        }
    }

    function wsUrlFromApiHost(apiHost) {
        const url = apiHost || window.location.origin;
        if (url.startsWith("https://")) return url.replace(/^https:\/\//, "wss://");
        if (url.startsWith("http://")) return url.replace(/^http:\/\//, "ws://");
        return (location.protocol === "https:" ? "wss://" : "ws://") + url;
    }

    function connectWS() {
        if (ws) ws.close();
        const ws_url = `${wsUrlFromApiHost(API_HOST || window.location.origin).replace(/\/$/, "")}/ws`;
        ws = new WebSocket(ws_url);

        ws.onopen = () => console.log("WebSocket connected");
        ws.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                if (data.type === 'log') {
                    setResult(data.content);
                }
            } catch (e) {
                console.error("Error parsing WS message:", e);
                setResult(event.data); // Показать сырой текст, если не JSON
            }
        };
        ws.onclose = () => {
            console.log("WebSocket closed, reconnecting...");
            clearTimeout(reconnectTimeout);
            reconnectTimeout = setTimeout(connectWS, 3000);
        };
        ws.onerror = (err) => console.error('WebSocket Error: ', err);
    }

    function setResult(text) {
        const block = document.getElementById("result-block");
        
        // Если приходит JSON с логами, парсим его
        try {
            const json_data = JSON.parse(text);
            if(json_data.type === 'log') {
                text = json_data.content;
            } else {
                // Если пришел другой тип сообщения, просто отображаем его как есть
                text = JSON.stringify(json_data, null, 2);
            }
        } catch (e) {
            // Если не JSON, это просто текстовый лог
        }

        // Разбиваем текст по строкам и добавляем в лог
        if (text) {
             // Если это 'Торговая операция завершена', очищаем блок
            if (text.includes('Торговая операция завершена')) {
                block.innerHTML = '';
            }
            
            text.split("\n").forEach(line => {
                if (line.trim().length > 0) {
                    const div = document.createElement("div");
                    div.className = "result-line";
                    div.textContent = line;
                    // Добавляем элемент сверху, чтобы он появился снизу благодаря column-reverse
                    block.prepend(div); 
                }
            });
            // Ограничиваем количество строк (например, до 50)
            while (block.children.length > 50) {
                block.removeChild(block.lastChild);
            }
        }
    }

    function startTrade() {
        const initData = resolveInitData();
        if (!initData) {
            return setResult("Ошибка: Не удалось получить данные Telegram для аутентификации.");
        }
        // Используем 50% от баланса, как "количество в USD"
        // На бэкенде нам нужно будет вычислить, какой процент баланса использовать на основе `total`
        const quantity_usd_estimate = 1000; // Здесь должно быть значение, которое бэкенд поймет
        
        fetch(`${(API_HOST || window.location.origin)}/start_trade`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "ngrok-skip-browser-warning": "true"
            },
            body: JSON.stringify({
                symbol: params.pair,
                action: params.action,
                quantity_usd: params.total, // Отправляем процент (total) как оценку quantity_usd
                profit_price_pct: params.profit,
                stop_loss_pct: params.loss,
                tg_init_data: initData // Отправляем initData для проверки
            })
        })
        .then(resp => resp.json())
        .then(data => {
            if (data.status === 'error') setResult(`Ошибка запуска: ${data.message}`);
            else setResult("Запуск торговой операции: OK");
        })
        .catch((e) => {
            console.error("Ошибка соединения с сервером (старт):", e);
            setResult("Ошибка соединения с сервером (старт)");
        });
    }

    // Изменение: stopTrade теперь останавливает активную торговую задачу
    function stopTrade() {
        const initData = resolveInitData();
        if (!initData) {
             return setResult("Ошибка: Не удалось получить данные Telegram для аутентификации.");
        }
        fetch(`${(API_HOST || window.location.origin)}/stop_trade`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "ngrok-skip-browser-warning": "true"
            },
            body: JSON.stringify({ tg_init_data: initData }) // Отправляем initData для проверки
        })
        .then(resp => resp.json())
        .then(data => {
            if (data.status === 'error') setResult(`Ошибка остановки: ${data.message}`);
            else setResult(`Торговая операция: ${data.message}`);
        })
        .catch((e) => {
            console.error("Ошибка соединения с сервером (стоп):", e);
            setResult("Ошибка соединения с сервером (стоп)");
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
        // Инициализация Telegram WebApp
        try { 
            if (window.Telegram && window.Telegram.WebApp && typeof Telegram.WebApp.ready === 'function') {
                Telegram.WebApp.ready(); 
            }
        } catch(e) {}

        updateDisplay();
        
        // Если initData уже присутствует (должно быть), то запускаем все
        if (resolveInitData()) {
            fetchAndShowBalance();
            connectWS();
        } else {
            setResult("Ожидание данных инициализации Telegram...");
            // В реальной работе бот должен получить данные инициализации практически мгновенно.
            // Если нет, это может указывать на проблему.
        }
    });
</script>
</body>
</html>
